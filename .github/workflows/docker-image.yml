name: Docker Image CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'docker/**'
      - 'Automotive and Diesel LMS/docker/**'
      - 'backend/lms_api/**'
      - '.github/workflows/docker-image.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'docker/**'
      - 'Automotive and Diesel LMS/docker/**'
      - 'backend/lms_api/**'
      - '.github/workflows/docker-image.yml'
  workflow_dispatch:

jobs:

  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4

    - name: Debug - show workspace and Dockerfile path
      run: |
        echo "PWD:"; pwd
        echo "Top-level files:"; ls -la || true
        echo "Automotive and Diesel LMS/docker/lms-api listing:"; ls -la "Automotive and Diesel LMS/docker/lms-api" || true

    - name: Check Dockerfile exists
      run: |
        if [ -f "Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" ]; then
          echo "Dockerfile.release FOUND"
        else
          echo "Dockerfile.release MISSING - workflow will fail if build attempted"; exit 1
        fi

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push (buildx)
      uses: docker/build-push-action@v6
      with:
        context: "Automotive and Diesel LMS"
        file: "docker/lms-api/Dockerfile.release"
        platforms: linux/amd64
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ghcr.io/${{ github.repository_owner }}/lms-api:latest
          ghcr.io/${{ github.repository_owner }}/lms-api:${{ github.sha }}
