name: Docker Image CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'docker/**'
      - 'Automotive and Diesel LMS/docker/**'
      - 'backend/lms_api/**'
      - '.github/workflows/docker-image.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'docker/**'
      - 'Automotive and Diesel LMS/docker/**'
      - 'backend/lms_api/**'
      - '.github/workflows/docker-image.yml'
  workflow_dispatch:

jobs:

  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: 'true'

    - name: Debug - show workspace and Dockerfile path
      run: |
        echo "PWD:"; pwd
        echo "Top-level files:"; ls -la || true
        echo "docker/lms-api listing:"; ls -la docker/lms-api || true
        echo "Automotive and Diesel LMS/docker/lms-api listing:"; ls -la "Automotive and Diesel LMS/docker/lms-api" || true
        echo "backend/lms_api exists at repo root:"; [ -d backend/lms_api ] && echo yes || echo no
        echo "backend/lms_api exists under Automotive and Diesel LMS:"; [ -d "Automotive and Diesel LMS/backend/lms_api" ] && echo yes || echo no

    - name: Determine Dockerfile and context
      id: dockerfile
      run: |
        set -euo pipefail
        # Prefer the Dockerfile.release, fall back to Dockerfile when present
        if [ -f "docker/lms-api/Dockerfile.release" ]; then
          # If backend exists at repo root, build from repo root so COPY backend/lms_api works
          if [ -d "backend/lms_api" ]; then
            echo "file=docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
            echo "context=." >> $GITHUB_OUTPUT
          else
            echo "file=docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
            echo "context=docker/lms-api" >> $GITHUB_OUTPUT
          fi
        elif [ -f "docker/lms-api/Dockerfile" ]; then
          if [ -d "backend/lms_api" ]; then
            echo "file=docker/lms-api/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=." >> $GITHUB_OUTPUT
          else
            echo "file=docker/lms-api/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=docker/lms-api" >> $GITHUB_OUTPUT
          fi
        elif [ -f "Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" ]; then
          # Dockerfile located under the spacey folder â€” choose context based on where backend lives
          if [ -d "Automotive and Diesel LMS/backend/lms_api" ]; then
            echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
            echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
          elif [ -d "backend/lms_api" ]; then
            # backend is at repo root but Dockerfile is in Automotive...; use repo root as context so COPY backend/lms_api works
            echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
            echo "context=." >> $GITHUB_OUTPUT
          else
            echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
            echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
          fi
        elif [ -f "Automotive and Diesel LMS/docker/lms-api/Dockerfile" ]; then
          if [ -d "Automotive and Diesel LMS/backend/lms_api" ]; then
            echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
          elif [ -d "backend/lms_api" ]; then
            echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=." >> $GITHUB_OUTPUT
          else
            echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
          fi
        else
          echo "No Dockerfile found in expected locations." >&2
          ls -la || true
          exit 1
        fi

    - name: Set up QEMU
      steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'true'

      - name: Debug - show workspace and Dockerfile path
        run: |
          echo "PWD:"; pwd
          echo "Top-level files:"; ls -la || true
          echo "docker/lms-api listing:"; ls -la docker/lms-api || true
          echo "Automotive and Diesel LMS/docker/lms-api listing:"; ls -la "Automotive and Diesel LMS/docker/lms-api" || true
          echo "backend/lms_api exists at repo root:"; [ -d backend/lms_api ] && echo yes || echo no
          echo "backend/lms_api exists under Automotive and Diesel LMS:"; [ -d "Automotive and Diesel LMS/backend/lms_api" ] && echo yes || echo no

      - name: Determine Dockerfile and context
        id: dockerfile
        run: |
          set -euo pipefail
          if [ -f "docker/lms-api/Dockerfile.release" ]; then
            if [ -d "backend/lms_api" ]; then
              echo "file=docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
              echo "context=." >> $GITHUB_OUTPUT
            elif [ -d "Automotive and Diesel LMS/backend/lms_api" ]; then
              echo "file=docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
              echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
            else
              echo "file=docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
              echo "context=." >> $GITHUB_OUTPUT
              echo "WARNING: backend/lms_api not found in repo root or Automotive and Diesel LMS; build may fail" >&2
            fi
          elif [ -f "Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" ]; then
            if [ -d "Automotive and Diesel LMS/backend/lms_api" ]; then
              echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
              echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
            elif [ -d "backend/lms_api" ]; then
              echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
              echo "context=." >> $GITHUB_OUTPUT
            else
              echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
              echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
              echo "WARNING: backend/lms_api not found; build may fail" >&2
            fi
          else
            echo "No Dockerfile found in expected locations." >&2
            ls -la || true
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (build-push-action)
        uses: docker/build-push-action@v4
        with:
          context: ${{ steps.dockerfile.outputs.context }}
          file: ${{ steps.dockerfile.outputs.file }}
          platforms: linux/amd64
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/lms-api:latest,ghcr.io/${{ github.repository_owner }}/lms-api:${{ github.sha }}
          pull: true
          no-cache: true
          progress: plain
