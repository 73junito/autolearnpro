name: Docker Image CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'docker/**'
      - 'Automotive and Diesel LMS/docker/**'
      - 'backend/lms_api/**'
      - '.github/workflows/docker-image.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'docker/**'
      - 'Automotive and Diesel LMS/docker/**'
      - 'backend/lms_api/**'
      - '.github/workflows/docker-image.yml'
  workflow_dispatch:

jobs:

  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4

    - name: Debug - show workspace and Dockerfile path
      run: |
        echo "PWD:"; pwd
        echo "Top-level files:"; ls -la || true
        echo "docker/lms-api listing:"; ls -la docker/lms-api || true
        echo "Automotive and Diesel LMS/docker/lms-api listing:"; ls -la "Automotive and Diesel LMS/docker/lms-api" || true

    - name: Determine Dockerfile and context
      id: dockerfile
      run: |
        set -euo pipefail
        if [ -f "docker/lms-api/Dockerfile.release" ]; then
          echo "file=docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
          echo "context=docker/lms-api" >> $GITHUB_OUTPUT
        elif [ -f "Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" ]; then
          echo "file=Automotive and Diesel LMS/docker/lms-api/Dockerfile.release" >> $GITHUB_OUTPUT
          echo "context=Automotive and Diesel LMS" >> $GITHUB_OUTPUT
        else
          echo "No Dockerfile found in expected locations." >&2
          ls -la || true
          exit 1
        fi

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push image (buildx CLI)
      env:
        IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/lms-api
        DOCKERFILE: ${{ steps.dockerfile.outputs.file }}
        BUILD_CONTEXT: ${{ steps.dockerfile.outputs.context }}
      run: |
        set -eo pipefail
        echo "Using Dockerfile: $DOCKERFILE"
        echo "Using context: $BUILD_CONTEXT"
        docker --version
        docker buildx version
        docker buildx create --use --name=ci-builder || true
        docker buildx build \
          --file "$DOCKERFILE" \
          --platform linux/amd64 \
          --push \
          --progress=plain \
          --pull \
          --no-cache \
          --tag ${IMAGE_NAME}:latest \
          --tag ${IMAGE_NAME}:${GITHUB_SHA} \
          "$BUILD_CONTEXT"
