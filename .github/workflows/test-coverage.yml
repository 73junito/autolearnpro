name: Test Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: lms_api_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      MIX_ENV: test
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/lms_api_test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.16'
          otp-version: '26'

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            backend/lms_api/deps
            backend/lms_api/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('backend/lms_api/mix.lock') }}
          restore-keys: ${{ runner.os }}-mix-

      - name: Install dependencies
        working-directory: backend/lms_api
        run: mix deps.get

      - name: Compile dependencies
        working-directory: backend/lms_api
        run: mix deps.compile

      - name: Wait for Postgres
        run: |
          for i in $(seq 1 30); do
            pg_isready -h localhost -p 5432 && { echo 'Postgres ready'; exit 0; }
            echo "Waiting for Postgres ($i/30)..."
            sleep 2
          done
          echo "Postgres did not become ready in time"
          exit 1

      - name: Run database migrations
        working-directory: backend/lms_api
        run: mix ecto.setup

      - name: Run tests with coverage
        working-directory: backend/lms_api
        run: mix coveralls.json
        continue-on-error: false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: backend/lms_api/cover/excoveralls.json
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Check coverage threshold
        working-directory: backend/lms_api
        run: |
          # If coverage JSON is missing, skip the threshold check (don't fail CI)
          if [ ! -f cover/excoveralls.json ]; then
            echo "Coverage JSON not found; skipping coverage threshold check."; exit 0
          fi
          # Safely parse coverage from JSON and enforce numeric coercion inside Python
          python3 - <<'PY'
import json,sys
try:
    data = json.load(open('cover/excoveralls.json'))
    cov = data.get('coverage') or data.get('coverage_percent') or data.get('total_coverage') or 0
    cov = float(cov)
except Exception as e:
    print('Failed to parse coverage JSON, skipping threshold check:', e)
    sys.exit(0)
print(f'Current coverage: {cov}%')
threshold = 70.0
if cov < threshold:
    print(f'‚ùå Coverage ({cov}%) is below threshold ({threshold}%)')
    sys.exit(1)
else:
    print(f'‚úÖ Coverage ({cov}%) meets threshold ({threshold}%)')
PY

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'backend/lms_api/cover/excoveralls.json';
            if (!fs.existsSync(path)) {
              console.log('Coverage file not found, skipping PR comment.');
              return;
            }
            let data = {};
            try {
              data = JSON.parse(fs.readFileSync(path, 'utf8')) || {};
            } catch (e) {
              console.log('Failed to parse coverage JSON, skipping PR comment:', e);
              return;
            }
            const raw = data.coverage || data.coverage_percent || data.total_coverage || 0;
            const coveragePercent = Number(raw) || 0;
            const covered_lines = data.covered_lines || 'N/A';
            const total_lines = data.total_lines || 'N/A';
            const meets = coveragePercent >= 70;
            const comment = `## üìä Test Coverage Report

**Overall Coverage:** ${coveragePercent.toFixed(2)}%

| Metric | Value |
|--------|-------|
| Lines Covered | ${covered_lines} |
| Total Lines | ${total_lines} |
| Coverage % | ${coveragePercent.toFixed(2)}% |

${meets ? '‚úÖ Coverage meets threshold (70%)' : '‚ùå Coverage below threshold (70%)'}`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Generate HTML coverage report
        if: always()
        working-directory: backend/lms_api
        run: mix coveralls.html

      - name: Upload HTML coverage report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/lms_api/cover/
          retention-days: 30
