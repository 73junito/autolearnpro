name: Rust Thumbnailer Benchmark

on:
  workflow_dispatch: {}

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python and Pillow
        run: |
          python -m pip install --upgrade pip
          python -m pip install pillow

      - name: Generate sample images
        run: |
          python - <<'PY'
          from PIL import Image
          import os
          os.makedirs('sample_images', exist_ok=True)
          for i in range(20):
              img = Image.new('RGB',(1920,1080),(i*10%256,i*5%256,i*3%256))
              img.save(f'sample_images/img_{i:03}.png')
          PY

      - name: Build
        run: cargo build --release --manifest-path tools/thumbnailer-rust/Cargo.toml

      - name: Run benchmark
        run: cargo run --release --manifest-path tools/thumbnailer-rust/Cargo.toml -- --input sample_images --output sample_thumbs --width 240 --height 160 --workers 4 --benchmark

      - name: Run Python baseline
        run: python tools/python_thumbnailer.py --input sample_images --output sample_thumbs_py --width 240 --height 160 --workers 4 --benchmark
      - name: Zip Rust thumbnails
        run: |
          if [ -d sample_thumbs ]; then
            zip -r rust-thumbs.zip sample_thumbs || true
          else
            echo "sample_thumbs directory not found"
          fi

      - name: Zip Python thumbnails
        run: |
          if [ -d sample_thumbs_py ]; then
            zip -r python-thumbs.zip sample_thumbs_py || true
          else
            echo "sample_thumbs_py directory not found"
          fi

      - name: Upload Rust thumbnails (zip)
        uses: actions/upload-artifact@v4
        with:
          name: rust-thumbs-zip
          path: rust-thumbs.zip

      - name: Upload Python thumbnails (zip)
        uses: actions/upload-artifact@v4
        with:
          name: python-thumbs-zip
          path: python-thumbs.zip

      - name: Install extended benchmark requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r tools/thumbnailer-rust/requirements.txt

      - name: Run extended benchmark grid (SSIM, PSNR, samples)
        run: |
          python tools/thumbnailer-rust/run_bench_grid.py \
            --rust-cmd "cargo run --release --manifest-path tools/thumbnailer-rust/Cargo.toml --" \
            --python-cmd "python tools/python_thumbnailer.py" \
            --input sample_images \
            --outdir bench_results \
            --width 240 --height 160 --workers 4 --qualities 80 90 95

      - name: Zip benchmark results
        run: |
          if [ -d bench_results ]; then
            zip -r bench-results.zip bench_results || true
          else
            echo "bench_results directory not found"
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: thumbnailer-bench-results
          path: bench-results.zip

      - name: Authenticate gh and download latest artifacts
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH: ${{ github.head_ref }}
          REFNAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          # install gh if missing
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install -y gh
          fi

          # authenticate non-interactively
          printf '%s' "$GH_TOKEN" | gh auth login --with-token
          gh auth status || true

          # determine branch
          if [ -z "$BRANCH" ]; then
            BRANCH="$REFNAME"
          fi

          echo "Searching for latest completed run on branch: $BRANCH"
          RUN_ID=$(gh run list --repo "$REPO" --workflow rust-thumbnailer-benchmark.yml --branch "$BRANCH" --limit 1 --json databaseId,status,conclusion --jq '.[] | select(.status=="completed") | .databaseId' | head -n1)

          if [ -n "$RUN_ID" ]; then
            echo "Downloading artifacts for run $RUN_ID"
            gh run download "$RUN_ID" --repo "$REPO" --dir "artifacts/run-$RUN_ID"
            echo "Artifacts downloaded to artifacts/run-$RUN_ID"
          else
            echo "No completed runs found yet."
          fi
