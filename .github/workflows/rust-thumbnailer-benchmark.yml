name: Rust Thumbnailer Benchmark

permissions:
  contents: read

on:
  workflow_dispatch: {}

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python and Pillow
        run: |
          python -m pip install --upgrade pip
          python -m pip install pillow

      - name: Generate sample images
        run: |
          python - <<'PY'
          from PIL import Image
          import os
          os.makedirs('sample_images', exist_ok=True)
          for i in range(20):
              img = Image.new('RGB',(1920,1080),(i*10%256,i*5%256,i*3%256))
              img.save(f'sample_images/img_{i:03}.png')
          PY

      - name: Build
        run: cargo build --release --manifest-path tools/thumbnailer-rust/Cargo.toml

      - name: Run benchmark
        run: cargo run --release --manifest-path tools/thumbnailer-rust/Cargo.toml -- --input sample_images --output sample_thumbs --width 240 --height 160 --workers 4 --benchmark

      - name: Run Python baseline
        run: python tools/python_thumbnailer.py --input sample_images --output sample_thumbs_py --width 240 --height 160 --workers 4 --benchmark

      - name: Upload Rust thumbnails
        uses: actions/upload-artifact@v4
        with:
          name: rust-thumbs
          path: sample_thumbs/**

      - name: Upload Python thumbnails
        uses: actions/upload-artifact@v4
        with:
          name: python-thumbs
          path: sample_thumbs_py/**

      - name: Authenticate gh and download latest artifacts
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH: ${{ github.head_ref }}
          REFNAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          # install gh if missing
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install -y gh
          fi

          # authenticate non-interactively
          printf '%s' "$GH_TOKEN" | gh auth login --with-token
          gh auth status || true

          # determine branch
          if [ -z "$BRANCH" ]; then
            BRANCH="$REFNAME"
          fi

          echo "Searching for latest completed run on branch: $BRANCH"
          RUN_ID=$(gh run list --repo "$REPO" --workflow rust-thumbnailer-benchmark.yml --branch "$BRANCH" --limit 1 --json databaseId,status,conclusion --jq '.[] | select(.status=="completed") | .databaseId' | head -n1)

          if [ -n "$RUN_ID" ]; then
            echo "Downloading artifacts for run $RUN_ID"
            gh run download "$RUN_ID" --repo "$REPO" --dir "artifacts/run-$RUN_ID"
            echo "Artifacts downloaded to artifacts/run-$RUN_ID"
          else
            echo "No completed runs found yet."
          fi
