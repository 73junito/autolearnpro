apiVersion: batch/v1
kind: Job
metadata:
  name: db-migrations-full-schema
  namespace: autolearnpro
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: migration
        image: postgres:15
        command:
        - /bin/bash
        - -c
        - |
          echo "========================================="
          echo "Database Migrations: Full LMS Schema"
          echo "========================================="
          echo ""
          
          psql -h postgres -U $PGUSER -d lms_api_prod <<'EOF'
          -- Migration 20251216000002: Create courses table
          CREATE TABLE IF NOT EXISTS courses (
            id SERIAL PRIMARY KEY,
            code VARCHAR(255) NOT NULL UNIQUE,
            title VARCHAR(255) NOT NULL,
            description TEXT,
            credits INTEGER NOT NULL,
            delivery_mode VARCHAR(255) NOT NULL DEFAULT 'online',
            level VARCHAR(255),
            duration_hours INTEGER,
            active BOOLEAN NOT NULL DEFAULT true,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS courses_active_index ON courses (active);
          CREATE INDEX IF NOT EXISTS courses_level_index ON courses (level);
          
          -- Migration 20251216000003: Create course_syllabus table
          CREATE TABLE IF NOT EXISTS course_syllabus (
            id SERIAL PRIMARY KEY,
            course_id INTEGER NOT NULL REFERENCES courses(id) ON DELETE CASCADE UNIQUE,
            learning_outcomes TEXT[],
            assessment_methods TEXT[],
            grading_breakdown JSONB,
            prerequisites TEXT[],
            required_materials TEXT,
            course_policies TEXT,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          -- Migration 20251216000004: Create course_modules table
          CREATE TABLE IF NOT EXISTS course_modules (
            id SERIAL PRIMARY KEY,
            course_id INTEGER NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
            title VARCHAR(255) NOT NULL,
            description TEXT,
            sequence_number INTEGER NOT NULL,
            duration_weeks INTEGER,
            objectives TEXT[],
            active BOOLEAN NOT NULL DEFAULT true,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS course_modules_course_id_index ON course_modules (course_id);
          CREATE INDEX IF NOT EXISTS course_modules_course_id_sequence_number_index ON course_modules (course_id, sequence_number);
          
          -- Migration 20251216000005: Create module_lessons table
          CREATE TABLE IF NOT EXISTS module_lessons (
            id SERIAL PRIMARY KEY,
            module_id INTEGER NOT NULL REFERENCES course_modules(id) ON DELETE CASCADE,
            title VARCHAR(255) NOT NULL,
            description TEXT,
            content TEXT,
            sequence_number INTEGER NOT NULL,
            lesson_type VARCHAR(255) DEFAULT 'lecture',
            duration_minutes INTEGER,
            objectives TEXT[],
            media_url VARCHAR(255),
            active BOOLEAN NOT NULL DEFAULT true,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS module_lessons_module_id_index ON module_lessons (module_id);
          CREATE INDEX IF NOT EXISTS module_lessons_module_id_sequence_number_index ON module_lessons (module_id, sequence_number);
          
          -- Migration 20251216000006: Create assessments and progress tables
          CREATE TABLE IF NOT EXISTS assessments (
            id SERIAL PRIMARY KEY,
            course_id INTEGER NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
            module_id INTEGER REFERENCES course_modules(id) ON DELETE SET NULL,
            title VARCHAR(255) NOT NULL,
            description TEXT,
            assessment_type VARCHAR(255) NOT NULL,
            total_points INTEGER DEFAULT 100,
            passing_score INTEGER DEFAULT 70,
            time_limit_minutes INTEGER,
            attempts_allowed INTEGER DEFAULT 3,
            active BOOLEAN NOT NULL DEFAULT true,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS assessments_course_id_index ON assessments (course_id);
          CREATE INDEX IF NOT EXISTS assessments_module_id_index ON assessments (module_id);
          
          CREATE TABLE IF NOT EXISTS assessment_questions (
            id SERIAL PRIMARY KEY,
            assessment_id INTEGER NOT NULL REFERENCES assessments(id) ON DELETE CASCADE,
            question_text TEXT NOT NULL,
            question_type VARCHAR(255) NOT NULL,
            points INTEGER DEFAULT 1,
            sequence_number INTEGER,
            options JSONB,
            correct_answer TEXT,
            explanation TEXT,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS assessment_questions_assessment_id_index ON assessment_questions (assessment_id);
          
          CREATE TABLE IF NOT EXISTS student_progress (
            id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
            lesson_id INTEGER NOT NULL REFERENCES module_lessons(id) ON DELETE CASCADE,
            status VARCHAR(255) DEFAULT 'not_started',
            completion_percentage INTEGER DEFAULT 0,
            time_spent_minutes INTEGER DEFAULT 0,
            last_accessed_at TIMESTAMP,
            completed_at TIMESTAMP,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
            CONSTRAINT student_progress_user_id_lesson_id_unique UNIQUE (user_id, lesson_id)
          );
          
          CREATE INDEX IF NOT EXISTS student_progress_user_id_index ON student_progress (user_id);
          CREATE INDEX IF NOT EXISTS student_progress_lesson_id_index ON student_progress (lesson_id);
          
          CREATE TABLE IF NOT EXISTS assessment_attempts (
            id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
            assessment_id INTEGER NOT NULL REFERENCES assessments(id) ON DELETE CASCADE,
            attempt_number INTEGER NOT NULL,
            score DECIMAL(5, 2),
            status VARCHAR(255) DEFAULT 'in_progress',
            started_at TIMESTAMP,
            submitted_at TIMESTAMP,
            answers JSONB,
            inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS assessment_attempts_user_id_index ON assessment_attempts (user_id);
          CREATE INDEX IF NOT EXISTS assessment_attempts_assessment_id_index ON assessment_attempts (assessment_id);
          CREATE INDEX IF NOT EXISTS assessment_attempts_user_id_assessment_id_index ON assessment_attempts (user_id, assessment_id);
          
          -- Record migrations
          INSERT INTO schema_migrations (version, inserted_at) 
          VALUES 
            (20251216000002, NOW()),
            (20251216000003, NOW()),
            (20251216000004, NOW()),
            (20251216000005, NOW()),
            (20251216000006, NOW())
          ON CONFLICT (version) DO NOTHING;
          
          -- Verify tables created
          SELECT 'Tables created successfully!' as status;
          \dt
          EOF
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "✓ All migrations completed successfully"
            echo ""
            echo "Database schema now includes:"
            echo "  - courses"
            echo "  - course_syllabus"
            echo "  - course_modules"
            echo "  - module_lessons"
            echo "  - assessments"
            echo "  - assessment_questions"
            echo "  - student_progress"
            echo "  - assessment_attempts"
            exit 0
          else
            echo ""
            echo "✗ Migration failed"
            exit 1
          fi
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: lms-api-secrets
              key: POSTGRES_PASSWORD
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: lms-api-secrets
              key: POSTGRES_USER
