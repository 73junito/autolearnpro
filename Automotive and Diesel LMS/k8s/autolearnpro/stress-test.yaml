apiVersion: batch/v1
kind: Job
metadata:
  name: lms-api-stress-test
  namespace: autolearnpro
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: stress-test
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache curl
          
          echo "===== LMS API CLUSTER STRESS TEST ====="
          echo "Target: http://lms-api:4000/api/health"
          echo "Duration: 60 seconds"
          echo "========================================"
          echo ""
          
          start=$(date +%s)
          count=0
          success=0
          failed=0
          total_time=0
          min_time=999999
          max_time=0
          
          echo "Running stress test..."
          echo ""
          
          while [ $(($(date +%s) - start)) -lt 60 ]; do
            req_start=$(date +%s%3N)
            
            if response=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" --max-time 5 http://lms-api:4000/api/health 2>/dev/null); then
              req_end=$(date +%s%3N)
              status_code=$(echo $response | cut -d: -f1)
              
              if [ "$status_code" = "200" ]; then
                success=$((success + 1))
                time=$((req_end - req_start))
                total_time=$((total_time + time))
                
                if [ $time -lt $min_time ]; then
                  min_time=$time
                fi
                if [ $time -gt $max_time ]; then
                  max_time=$time
                fi
              else
                failed=$((failed + 1))
              fi
            else
              failed=$((failed + 1))
            fi
            
            count=$((count + 1))
            
            # Progress every 200 requests
            if [ $((count % 200)) -eq 0 ]; then
              elapsed=$(($(date +%s) - start))
              if [ $elapsed -gt 0 ]; then
                rate=$((count / elapsed))
              else
                rate=0
              fi
              success_pct=$((success * 100 / count))
              echo "Progress: $count requests | Success: $success ($success_pct%) | Rate: ~$rate req/s"
            fi
            
            # Small delay to not overwhelm
            sleep 0.01
          done
          
          # Calculate final statistics
          elapsed=$(($(date +%s) - start))
          
          if [ $elapsed -gt 0 ]; then
            rate_100=$((count * 100 / elapsed))
            rate_int=$((rate_100 / 100))
            rate_dec=$((rate_100 % 100))
          else
            rate_int=0
            rate_dec=0
          fi
          
          if [ $count -gt 0 ]; then
            success_pct=$((success * 100 / count))
            failed_pct=$((failed * 100 / count))
          else
            success_pct=0
            failed_pct=0
          fi
          
          if [ $success -gt 0 ]; then
            avg_time=$((total_time / success))
          else
            avg_time=0
          fi
          
          echo ""
          echo "=============================================="
          echo "CLUSTER STRESS TEST RESULTS"
          echo "=============================================="
          echo ""
          echo "Test Configuration:"
          echo "  Duration:         ${elapsed}s"
          echo "  Target:           lms-api:4000/api/health"
          echo "  Test Location:    Within Kubernetes cluster"
          echo ""
          echo "Request Statistics:"
          echo "  Total Requests:   $count"
          echo "  Successful:       $success ($success_pct%)"
          echo "  Failed:           $failed ($failed_pct%)"
          echo ""
          echo "Performance Metrics:"
          echo "  Throughput:       $rate_int.$rate_dec req/s"
          echo "  Avg Response:     ${avg_time} ms"
          echo "  Min Response:     ${min_time} ms"
          echo "  Max Response:     ${max_time} ms"
          echo ""
          echo "=============================================="
          echo ""
          
          if [ $failed -eq 0 ]; then
            echo "✓ EXCELLENT - Zero failures under cluster load!"
            echo "  The LMS API handled $count requests flawlessly"
            exit 0
          elif [ $failed_pct -lt 1 ]; then
            echo "✓ GOOD - Minimal failures (<1%)"
            exit 0
          elif [ $failed_pct -lt 5 ]; then
            echo "⚠ ACCEPTABLE - Some failures (<5%)"
            exit 0
          else
            echo "✗ WARNING - High failure rate (>5%)"
            exit 1
          fi
