apiVersion: batch/v1
kind: Job
metadata:
  name: frontend-stress-test
  namespace: autolearnpro
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: stress-test
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache curl
          
          echo "===== FRONTEND CLUSTER STRESS TEST ====="
          echo "Target: http://frontend:80/"
          echo "Duration: 60 seconds"
          echo "========================================="
          echo ""
          
          start=$(date +%s)
          count=0
          success=0
          failed=0
          total_time=0
          min_time=999999
          max_time=0
          status_codes=""
          
          echo "Running stress test..."
          echo ""
          
          while [ $(($(date +%s) - start)) -lt 60 ]; do
            req_start=$(date +%s%3N)
            
            if response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://frontend:80/ 2>/dev/null); then
              req_end=$(date +%s%3N)
              
              # Check if status code is 2xx or 3xx (success)
              case "$response" in
                2*|3*)
                  success=$((success + 1))
                  time=$((req_end - req_start))
                  total_time=$((total_time + time))
                  
                  if [ $time -lt $min_time ]; then
                    min_time=$time
                  fi
                  if [ $time -gt $max_time ]; then
                    max_time=$time
                  fi
                  ;;
                *)
                  failed=$((failed + 1))
                  ;;
              esac
              
              # Track status code distribution
              status_codes="$status_codes $response"
            else
              failed=$((failed + 1))
            fi
            
            count=$((count + 1))
            
            # Progress every 200 requests
            if [ $((count % 200)) -eq 0 ]; then
              elapsed=$(($(date +%s) - start))
              if [ $elapsed -gt 0 ]; then
                rate=$((count / elapsed))
              else
                rate=0
              fi
              success_pct=$((success * 100 / count))
              echo "Progress: $count requests | Success: $success ($success_pct%) | Rate: ~$rate req/s"
            fi
            
            # Small delay
            sleep 0.01
          done
          
          # Calculate final statistics
          elapsed=$(($(date +%s) - start))
          
          if [ $elapsed -gt 0 ]; then
            rate_100=$((count * 100 / elapsed))
            rate_int=$((rate_100 / 100))
            rate_dec=$((rate_100 % 100))
          else
            rate_int=0
            rate_dec=0
          fi
          
          if [ $count -gt 0 ]; then
            success_pct=$((success * 100 / count))
            failed_pct=$((failed * 100 / count))
          else
            success_pct=0
            failed_pct=0
          fi
          
          if [ $success -gt 0 ]; then
            avg_time=$((total_time / success))
          else
            avg_time=0
          fi
          
          # Count unique status codes
          status_200=$(echo "$status_codes" | tr ' ' '\n' | grep -c '^200$' || echo 0)
          status_301=$(echo "$status_codes" | tr ' ' '\n' | grep -c '^301$' || echo 0)
          status_302=$(echo "$status_codes" | tr ' ' '\n' | grep -c '^302$' || echo 0)
          status_404=$(echo "$status_codes" | tr ' ' '\n' | grep -c '^404$' || echo 0)
          status_500=$(echo "$status_codes" | tr ' ' '\n' | grep -c '^500$' || echo 0)
          
          echo ""
          echo "=============================================="
          echo "FRONTEND STRESS TEST RESULTS"
          echo "=============================================="
          echo ""
          echo "Test Configuration:"
          echo "  Duration:         ${elapsed}s"
          echo "  Target:           frontend:80/"
          echo "  Test Location:    Within Kubernetes cluster"
          echo ""
          echo "Request Statistics:"
          echo "  Total Requests:   $count"
          echo "  Successful:       $success ($success_pct%)"
          echo "  Failed:           $failed ($failed_pct%)"
          echo ""
          echo "Performance Metrics:"
          echo "  Throughput:       $rate_int.$rate_dec req/s"
          echo "  Avg Response:     ${avg_time} ms"
          echo "  Min Response:     ${min_time} ms"
          echo "  Max Response:     ${max_time} ms"
          echo ""
          echo "HTTP Status Codes:"
          if [ $status_200 -gt 0 ]; then
            echo "  200 OK:           $status_200"
          fi
          if [ $status_301 -gt 0 ]; then
            echo "  301 Redirect:     $status_301"
          fi
          if [ $status_302 -gt 0 ]; then
            echo "  302 Redirect:     $status_302"
          fi
          if [ $status_404 -gt 0 ]; then
            echo "  404 Not Found:    $status_404"
          fi
          if [ $status_500 -gt 0 ]; then
            echo "  500 Error:        $status_500"
          fi
          echo ""
          echo "=============================================="
          echo ""
          
          if [ $failed -eq 0 ]; then
            echo "✓ EXCELLENT - Zero failures under load!"
            echo "  The frontend handled $count requests flawlessly"
            exit 0
          elif [ $failed_pct -lt 1 ]; then
            echo "✓ GOOD - Minimal failures (<1%)"
            exit 0
          elif [ $failed_pct -lt 5 ]; then
            echo "⚠ ACCEPTABLE - Some failures (<5%)"
            exit 0
          else
            echo "✗ WARNING - High failure rate (>5%)"
            exit 1
          fi
